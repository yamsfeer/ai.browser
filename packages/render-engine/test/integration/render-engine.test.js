import { describe, it, expect, beforeEach, vi } from 'vitest';
import { RenderEngine } from '../../src/RenderEngine.js';

// ÂàõÂª∫ÊµãËØïÁî®ÁöÑCanvasÂÖÉÁ¥†
function createTestCanvas(width = 800, height = 600) {
  const canvas = {
    width,
    height,
    getContext: type => {
      if (type !== '2d') {
        throw new Error('Only 2d context is supported');
      }

      return {
        fillStyle: '#000000',
        strokeStyle: '#000000',
        lineWidth: 1,
        globalAlpha: 1,
        globalCompositeOperation: 'source-over',
        font: '16px serif',
        textAlign: 'left',
        textBaseline: 'top',
        shadowColor: 'transparent',
        shadowBlur: 0,
        shadowOffsetX: 0,
        shadowOffsetY: 0,
        save: vi.fn(),
        restore: vi.fn(),
        clearRect: vi.fn(),
        fillRect: vi.fn(),
        strokeRect: vi.fn(),
        fillText: vi.fn(),
        strokeText: vi.fn(),
        beginPath: vi.fn(),
        moveTo: vi.fn(),
        lineTo: vi.fn(),
        stroke: vi.fn(),
        setLineDash: vi.fn(),
        measureText: text => ({ width: text.length * 8 }),
        translate: vi.fn(),
        transform: vi.fn(),
        rect: vi.fn(),
        clip: vi.fn(),
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
        drawImage: vi.fn(),
      };
    },
  };

  return canvas;
}

// ÂàõÂª∫Ê®°ÊãüÁöÑÊ∏≤ÊüìÊ†ë
function createMockRenderTree() {
  return {
    root: {
      type: 'element',
      tagName: 'div',
      style: {
        width: '800px',
        height: '600px',
        backgroundColor: '#ffffff',
        position: 'relative'
      },
      layout: {
        x: 0,
        y: 0,
        width: 800,
        height: 600
      },
      children: [
        {
          type: 'element',
          tagName: 'h1',
          element: { data: 'ÊµãËØïÊ†áÈ¢ò' },
          style: {
            fontSize: '24px',
            color: '#333333',
            margin: '20px'
          },
          layout: {
            x: 20,
            y: 20,
            width: 760,
            height: 30
          },
          children: []
        },
        {
          type: 'element',
          tagName: 'p',
          element: { data: 'ËøôÊòØ‰∏Ä‰∏™ÊµãËØïÊÆµËêΩ„ÄÇ' },
          style: {
            fontSize: '16px',
            color: '#666666',
            margin: '10px 20px'
          },
          layout: {
            x: 20,
            y: 70,
            width: 760,
            height: 20
          },
          children: []
        }
      ]
    }
  };
}

describe('Ê∏≤ÊüìÂºïÊìéÈõÜÊàêÊµãËØï', () => {
  let renderEngine;
  let canvas;

  beforeEach(() => {
    canvas = createTestCanvas();
    renderEngine = new RenderEngine(canvas);
  });

  describe('Ê∏≤ÊüìÂºïÊìéÂàùÂßãÂåñ', () => {
    it('Â∫îËØ•Ê≠£Á°ÆÂàùÂßãÂåñÊ∏≤ÊüìÂºïÊìé', () => {
      expect(renderEngine).toBeDefined();
      expect(renderEngine.canvas).toBe(canvas);
      expect(renderEngine.context).toBeDefined();
      expect(renderEngine.layerTreeCalculator).toBeDefined();
      expect(renderEngine.paintRecordGenerator).toBeDefined();
      expect(renderEngine.gpuSimulator).toBeDefined();
      expect(renderEngine.compositor).toBeDefined();
    });

    it('Â∫îËØ•ÊîØÊåÅÈÖçÁΩÆÈÄâÈ°π', () => {
      const customEngine = new RenderEngine(canvas, {
        debug: true,
        enableCompositingOptimization: false,
        maxLayerCount: 500,
        enableBatching: true,
        maxDrawQuads: 5000
      });

      expect(customEngine.debugMode).toBe(true);
    });
  });

  describe('ÂÆåÊï¥Ê∏≤ÊüìÊµÅÁ®ã', () => {
    it('Â∫îËØ•ËÉΩÂ§üÊâßË°åÂÆåÊï¥ÁöÑÊ∏≤ÊüìÁÆ°Á∫ø', () => {
      const renderTree = createMockRenderTree();

      const stats = renderEngine.render(renderTree);

      expect(stats).toBeDefined();
      expect(stats.totalNodes).toBeGreaterThanOrEqual(0);
      expect(stats.paintRecordsGenerated).toBeGreaterThanOrEqual(0);
      expect(stats.layersCreated).toBeGreaterThanOrEqual(0);
      expect(stats.drawQuadsCreated).toBeGreaterThanOrEqual(0);
      expect(stats.totalRenderTime).toBeGreaterThanOrEqual(0);
      expect(stats.frameCount).toBe(1);
    });

    it('Â∫îËØ•ÊîØÊåÅË∞ÉËØïÊ®°ÂºèÊ∏≤Êüì', () => {
      const consoleSpy = vi.spyOn(console, 'log').mockImplementation(() => {});

      renderEngine.setDebugMode(true);
      const renderTree = createMockRenderTree();

      renderEngine.render(renderTree);

      expect(consoleSpy).toHaveBeenCalledWith('üìä ÂºÄÂßãËÆ°ÁÆóLayer Tree...');
      expect(consoleSpy).toHaveBeenCalledWith('üé® ÂºÄÂßãÁîüÊàêPaint Records...');
      expect(consoleSpy).toHaveBeenCalledWith('üîß ÂºÄÂßãGPUÂÖâÊ†ÖÂåñ...');
      expect(consoleSpy).toHaveBeenCalledWith('üöÄ ÂºÄÂßãGPUÊ∏≤Êüì...');
      expect(consoleSpy).toHaveBeenCalledWith('üé≠ ÂºÄÂßãÂêàÊàêÂô®Â§ÑÁêÜ...');

      consoleSpy.mockRestore();
    });

    it('Â∫îËØ•Â§ÑÁêÜÁ©∫Ê∏≤ÊüìÊ†ë', () => {
      const emptyRenderTree = { root: null };

      expect(() => {
        renderEngine.render(emptyRenderTree);
      }).not.toThrow();
    });

    it('Â∫îËØ•Â§ÑÁêÜÊó†ÊïàÊ∏≤ÊüìÊ†ë', () => {
      const invalidRenderTree = {};

      expect(() => {
        renderEngine.render(invalidRenderTree);
      }).not.toThrow();
    });
  });

  describe('GPUÊ∏≤ÊüìÁÆ°Á∫ø', () => {
    it('Â∫îËØ•Ê≠£Á°ÆÊâßË°åGPUÂÖâÊ†ÖÂåñ', () => {
      const renderTree = createMockRenderTree();

      renderEngine.render(renderTree);

      const gpuInfo = renderEngine.gpuSimulator.getGPUInfo();
      expect(gpuInfo).toBeDefined();
      expect(gpuInfo.maxDrawQuads).toBeGreaterThan(0);
      expect(gpuInfo.textureCount).toBeGreaterThanOrEqual(0);
      expect(gpuInfo.enableBatching).toBeDefined();
    });

    it('Â∫îËØ•ÁîüÊàêGPUÊÄßËÉΩÁªüËÆ°', () => {
      const renderTree = createMockRenderTree();

      renderEngine.render(renderTree);

      const gpuStats = renderEngine.gpuSimulator.getPerformanceStats();
      expect(gpuStats).toBeDefined();
      expect(gpuStats.totalDrawCalls).toBeGreaterThanOrEqual(0);
      expect(gpuStats.totalQuads).toBeGreaterThanOrEqual(0);
      expect(gpuStats.totalTriangles).toBeGreaterThanOrEqual(0);
      expect(gpuStats.frameTime).toBeGreaterThanOrEqual(0);
    });
  });

  describe('Â¢ûÈáèÊ∏≤Êüì', () => {
    it('Â∫îËØ•ÊîØÊåÅÂ¢ûÈáèÊ∏≤Êüì', () => {
      const initialTree = createMockRenderTree();
      renderEngine.render(initialTree);

      const modifiedTree = {
        ...initialTree,
        root: {
          ...initialTree.root,
          style: {
            ...initialTree.root.style,
            backgroundColor: '#f0f0f0'
          }
        }
      };

      const stats = renderEngine.incrementalRender(modifiedTree, []);

      expect(stats).toBeDefined();
      expect(stats.frameCount).toBeGreaterThanOrEqual(1);
    });

    it('È¶ñÊ¨°Â¢ûÈáèÊ∏≤ÊüìÂ∫îËØ•ÂõûÈÄÄÂà∞ÂÆåÊï¥Ê∏≤Êüì', () => {
      const renderTree = createMockRenderTree();

      const stats = renderEngine.incrementalRender(renderTree, []);

      expect(stats).toBeDefined();
      expect(stats.totalNodes).toBeGreaterThanOrEqual(0);
    });
  });

  describe('ÊÄßËÉΩÁªüËÆ°', () => {
    it('Â∫îËØ•Êèê‰æõËØ¶ÁªÜÁöÑÊ∏≤ÊüìÁªüËÆ°', () => {
      const renderTree = createMockRenderTree();

      renderEngine.render(renderTree);
      const stats = renderEngine.getStats();

      expect(stats).toBeDefined();
      expect(stats.totalNodes).toBeGreaterThanOrEqual(0);
      expect(stats.paintRecordsGenerated).toBeGreaterThanOrEqual(0);
      expect(stats.layersCreated).toBeGreaterThanOrEqual(0);
      expect(stats.drawQuadsCreated).toBeGreaterThanOrEqual(0);
      expect(stats.tilesCreated).toBeGreaterThanOrEqual(0);
      expect(stats.compositorTime).toBeGreaterThanOrEqual(0);
      expect(stats.gpuTime).toBeGreaterThanOrEqual(0);
      expect(stats.totalRenderTime).toBeGreaterThanOrEqual(0);
      expect(stats.frameCount).toBeGreaterThanOrEqual(0);
      expect(stats.averageFrameTime).toBeGreaterThanOrEqual(0);
    });

    it('Â∫îËØ•ËÆ°ÁÆóÂπ≥ÂùáÂ∏ßÊó∂Èó¥', () => {
      const renderTree = createMockRenderTree();

      // Ê∏≤ÊüìÂ§öÂ∏ß
      renderEngine.render(renderTree);
      renderEngine.render(renderTree);
      renderEngine.render(renderTree);

      const stats = renderEngine.getStats();
      expect(stats.frameCount).toBe(3);
      expect(stats.averageFrameTime).toBeGreaterThan(0);
    });
  });

  describe('Ê∏≤ÊüìÁÆ°Á∫ø‰ø°ÊÅØ', () => {
    it('Â∫îËØ•Êèê‰æõÂÆåÊï¥ÁöÑÁÆ°Á∫ø‰ø°ÊÅØ', () => {
      const renderTree = createMockRenderTree();

      renderEngine.render(renderTree);
      const pipelineInfo = renderEngine.getPipelineInfo();

      expect(pipelineInfo).toBeDefined();
      expect(pipelineInfo.layerTreeCalculator).toBeDefined();
      expect(pipelineInfo.paintRecordGenerator).toBeDefined();
      expect(pipelineInfo.compositor).toBeDefined();
      expect(pipelineInfo.layerTree).toBeDefined();
      expect(pipelineInfo.compositingReasons).toBeDefined();
      expect(pipelineInfo.currentStats).toBeDefined();
    });
  });

  describe('CanvasÁÆ°ÁêÜ', () => {
    it('Â∫îËØ•ÊîØÊåÅË∞ÉÊï¥CanvasÂ§ßÂ∞è', () => {
      renderEngine.resizeCanvas(1024, 768);

      expect(canvas.width).toBe(1024);
      expect(canvas.height).toBe(768);
    });

    it('Ë∞ÉÊï¥Â§ßÂ∞èÂêéÂ∫îËØ•ËÉΩÊ≠£Â∏∏Ê∏≤Êüì', () => {
      renderEngine.resizeCanvas(500, 400);

      const renderTree = createMockRenderTree();
      const stats = renderEngine.render(renderTree);

      expect(stats).toBeDefined();
      expect(stats.paintRecordsGenerated).toBeGreaterThanOrEqual(0);
    });
  });

  describe('ÈîôËØØÂ§ÑÁêÜ', () => {
    it('Â∫îËØ•Â§ÑÁêÜÊ∏≤ÊüìÈîôËØØ', () => {
      // Ê®°ÊãüCanvas‰∏ä‰∏ãÊñáÈîôËØØ
      const originalFillRect = canvas.getContext('2d').fillRect;
      canvas.getContext('2d').fillRect = vi.fn(() => {
        throw new Error('Canvas rendering error');
      });

      const renderTree = createMockRenderTree();

      expect(() => {
        renderEngine.render(renderTree);
      }).not.toThrow();

      // ÊÅ¢Â§ç
      canvas.getContext('2d').fillRect = originalFillRect;
    });

    it('Â∫îËØ•Â§ÑÁêÜÊó†ÊïàÁöÑÊ∏≤ÊüìÈÄâÈ°π', () => {
      const renderTree = createMockRenderTree();

      expect(() => {
        renderEngine.render(renderTree, null);
        renderEngine.render(renderTree, undefined);
        renderEngine.render(renderTree, { invalid: 'option' });
      }).not.toThrow();
    });
  });

  describe('ÂÜÖÂ≠òÁÆ°ÁêÜ', () => {
    it('Â∫îËØ•Ê≠£Á°ÆÈîÄÊØÅÊ∏≤ÊüìÂºïÊìé', () => {
      const renderTree = createMockRenderTree();
      renderEngine.render(renderTree);

      expect(() => {
        renderEngine.dispose();
      }).not.toThrow();

      expect(renderEngine.currentLayerTree).toBeNull();
      expect(renderEngine.lastRenderTree).toBeNull();
    });

    it('ÈîÄÊØÅÂêéÂ∫îËØ•ËÉΩÈáçÊñ∞ÂàùÂßãÂåñ', () => {
      renderEngine.dispose();

      expect(() => {
        renderEngine = new RenderEngine(canvas);
        const renderTree = createMockRenderTree();
        renderEngine.render(renderTree);
      }).not.toThrow();
    });
  });

  describe('Â§çÊùÇÊ∏≤ÊüìÂú∫ÊôØ', () => {
    it('Â∫îËØ•Â§ÑÁêÜÂ§öÂ±ÇÂµåÂ•óÁöÑÊ∏≤ÊüìÊ†ë', () => {
      const complexRenderTree = {
        root: {
          type: 'element',
          tagName: 'div',
          style: {
            width: '800px',
            height: '600px',
            position: 'relative'
          },
          layout: {
            x: 0,
            y: 0,
            width: 800,
            height: 600
          },
          children: Array.from({ length: 10 }, (_, i) => ({
            type: 'element',
            tagName: 'div',
            style: {
              position: 'absolute',
              left: `${i * 80}px`,
              top: `${i * 60}px`,
              width: '70px',
              height: '50px',
              backgroundColor: `hsl(${i * 36}, 70%, 50%)`
            },
            layout: {
              x: i * 80,
              y: i * 60,
              width: 70,
              height: 50
            },
            children: []
          }))
        }
      };

      const startTime = performance.now();
      const stats = renderEngine.render(complexRenderTree);
      const endTime = performance.now();

      expect(stats).toBeDefined();
      expect(stats.layersCreated).toBeGreaterThan(0);
      expect(endTime - startTime).toBeLessThan(1000); // Â∫îËØ•Âú®1ÁßíÂÜÖÂÆåÊàê
    });

    it('Â∫îËØ•Â§ÑÁêÜÂ§ßÈáèÊ∏≤ÊüìÂÖÉÁ¥†', () => {
      const massiveRenderTree = {
        root: {
          type: 'element',
          tagName: 'div',
          style: {
            width: '800px',
            height: '600px',
            backgroundColor: '#ffffff',
            position: 'relative'
          },
          layout: { x: 0, y: 0, width: 800, height: 600 },
          children: Array.from({ length: 100 }, (_, i) => ({
            type: 'element',
            tagName: 'span',
            element: { data: `Element ${i}` },
            style: {
              fontSize: '12px',
              color: '#333333',
              backgroundColor: `hsl(${i * 3.6}, 50%, 90%)`,
              position: 'absolute',
              left: `${(i % 10) * 80}px`,
              top: `${Math.floor(i / 10) * 30}px`,
              width: '70px',
              height: '20px',
              display: 'block'
            },
            layout: {
              x: (i % 10) * 80,
              y: Math.floor(i / 10) * 30,
              width: 70,
              height: 20
            },
            children: []
          }))
        }
      };

      const stats = renderEngine.render(massiveRenderTree);

      expect(stats).toBeDefined();
      // Áî±‰∫éPaint RecordÁîüÊàêÈÄªËæëÂèØËÉΩÊØîËæÉÂ§çÊùÇÔºåÊàë‰ª¨Âè™Ê£ÄÊü•Âü∫Êú¨Ê∏≤ÊüìÂÆåÊàê
      expect(stats.totalRenderTime).toBeGreaterThanOrEqual(0);
      expect(stats.frameCount).toBeGreaterThanOrEqual(1);
    });
  });
});